{% extends "base.html" %}

{% block title %}Content Management Hub - Organize Conversations{% endblock %}

{% block content %}
<!-- Main Application -->
<div x-data="conversationBrowser()">
    <!-- Header -->
    {% set page_title="Organize Conversations" %}
    {% set show_new_client_button=True %}
    {% set show_new_project_button=True %}
    {% set show_new_folder_button=True %}
    {% include "components/header.html" %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center py-12">
            <div class="loading loading-spinner loading-lg"></div>
            <span class="ml-4 text-gray-600">Loading conversations...</span>
        </div>

        <!-- Error State -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-md p-4 flex items-center">
            <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span x-text="error"></span>
        </div>

        <!-- Content -->
        <div x-show="!loading && !error">
            <!-- Advanced Search Interface -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Advanced Search</h2>
                        <div class="flex space-x-2">
                            <button @click="clearConversationFilters()" 
                                    class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mb-6 flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <a href="/search" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-search mr-2"></i>
                                Advanced Search
                            </a>
                            <span class="text-sm text-gray-600">
                                Use our hybrid search to find conversations and content
                            </span>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <!-- Client Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                            <select x-model="filters.clientId" @change="applyConversationFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Clients</option>
                                <template x-for="client in clients" :key="client.id">
                                    <option :value="client.id" x-text="client.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Project Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                            <select x-model="filters.projectId" @change="applyConversationFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Projects</option>
                                <template x-for="project in projects" :key="project.id">
                                    <option :value="project.id" x-text="project.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Content Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                            <select x-model="filters.contentType" @change="applyConversationFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Types</option>
                                <option value="blog_post">Blog Post</option>
                                <option value="social_media">Social Media</option>
                                <option value="email_campaign">Email Campaign</option>
                                <option value="ad_copy">Ad Copy</option>
                                <option value="press_release">Press Release</option>
                                <option value="case_study">Case Study</option>
                            </select>
                        </div>
                        
                        <!-- Status Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select x-model="filters.status" @change="applyConversationFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="review">Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="published">Published</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Date Range Filter -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" x-model="filters.startDate" @change="applyConversationFilters()"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" x-model="filters.endDate" @change="applyConversationFilters()"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <template x-for="(value, key) in filters" :key="key">
                            <span x-show="value" 
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                <span x-text="getConversationFilterLabel(key, value)"></span>
                                <button @click="filters[key] = ''; applyConversationFilters()" 
                                        class="ml-1.5 inline-flex items-center justify-center w-4 h-4 rounded-full text-indigo-400 hover:bg-indigo-200 hover:text-indigo-500 focus:outline-none focus:bg-indigo-500 focus:text-white">
                                    <span class="sr-only">Remove</span>
                                    <svg class="w-2 h-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                        <path stroke-linecap="round" stroke-width="1.5" d="m1 1 6 6m0-6-6 6" />
                                    </svg>
                                </button>
                            </span>
                        </template>
                    </div>
                    
                    <!-- Search Results Summary -->
                    <div x-show="searchResults.length > 0 || (filters.clientId || filters.projectId || filters.contentType || filters.status || filters.startDate || filters.endDate)" class="text-sm text-gray-600 mb-4">
                        Found <span x-text="getFilteredConversationCount()"></span> conversations matching your search
                    </div>
                </div>
            </div>
            
            <!-- Status Overview Cards -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Content Status Overview</h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-600" x-text="statusCounts.draft || 0"></div>
                            <div class="text-sm text-gray-500">Draft</div>
                        </div>
                        <div class="text-center p-3 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" x-text="statusCounts.review || 0"></div>
                            <div class="text-sm text-gray-500">Review</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" x-text="statusCounts.approved || 0"></div>
                            <div class="text-sm text-gray-500">Approved</div>
                        </div>
                        <div class="text-center p-3 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" x-text="statusCounts.rejected || 0"></div>
                            <div class="text-sm text-gray-500">Rejected</div>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" x-text="statusCounts.published || 0"></div>
                            <div class="text-sm text-gray-500">Published</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Root Level Conversations -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Root Conversations</h2>
                    <p class="text-sm text-gray-600">Conversations not organized into folders</p>
                </div>
                <div class="p-6">
                    <div id="root-conversations" 
                         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                         x-data="{}"
                         x-init="
                            console.log('Initializing sortables...');
                            console.log('Current folders:', folders.length);
                            console.log('Current root conversations:', rootConversations.length);
                            
                            // Initialize sortable for root conversations
                            setTimeout(() => {
                                if (typeof Sortable !== 'undefined') {
                                    const rootSortable = new Sortable(document.getElementById('root-conversations'), {
                                        group: 'conversations',
                                        animation: 150,
                                        ghostClass: 'sortable-ghost',
                                        chosenClass: 'sortable-chosen',
                                        onEnd: function(evt) {
                                            console.log('Root conversation moved:', evt);
                                            // Handle conversation move logic here
                                        }
                                    });
                                    console.log('Sortable instances created:', ['root-conversations']);
                                }
                            }, 100);
                         ">
                        <template x-for="conversation in rootConversations" :key="conversation.id">
                            <div class="conversation-item bg-white border rounded-lg p-4 hover:shadow-md transition-shadow"
                                 :class="conversation.message_count > 0 ? 'border-gray-200' : 'border-orange-200 bg-orange-50'">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-sm font-medium text-gray-900 truncate" x-text="conversation.title"></h3>
                                        <!-- Debug info -->
                                        <div class="text-xs text-gray-400" x-text="'ID: ' + conversation.id"></div>
                                        <div x-show="conversation.message_count === 0" class="text-xs text-orange-600 font-medium mt-1">
                                            ⚠️ Empty conversation - no messages yet
                                        </div>
                                        <div class="mt-1 flex items-center space-x-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="getStatusClass(conversation.status)"
                                                  x-text="conversation.status || 'draft'"></span>
                                        </div>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                                            <span x-text="new Date(conversation.updated_at).toLocaleDateString()"></span>
                                            <span x-show="conversation.client_name" 
                                                  x-text="'Client: ' + conversation.client_name"></span>
                                            <span x-show="conversation.project_name" 
                                                  x-text="'Project: ' + conversation.project_name"></span>
                                            <span x-show="conversation.content_type" 
                                                  x-text="'Type: ' + conversation.content_type"></span>
                                            <span class="text-orange-600 font-medium" x-text="conversation.message_count ? conversation.message_count + ' messages' : 'No messages'"></span>
                                        </div>
                                        <div class="flex flex-wrap gap-1 mt-2" x-show="conversation.tags && conversation.tags.length > 0">
                                            <template x-for="tag in conversation.tags" :key="tag.id">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                                                      x-text="tag.name"></span>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 ml-2">
                                        <button @click="viewConversation(conversation.id)"
                                                class="p-1 text-gray-400 hover:text-blue-600"
                                                title="View Conversation">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button @click="deleteConversation(conversation.id)"
                                                class="p-1 text-gray-400 hover:text-red-600"
                                                title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="rootConversations.length === 0" 
                             class="col-span-full text-center text-gray-500 py-8">
                            <p>No conversations at root level</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project-Based Folders -->
            <div x-show="projectsWithFolders.length > 0" class="bg-white rounded-lg shadow-sm border mt-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Project Folders</h2>
                    <p class="text-sm text-gray-600">Folders organized by project</p>
                </div>
                <div class="p-6">
                    <template x-for="project in projectsWithFolders" :key="project.id">
                        <div class="mb-6 last:mb-0">
                            <div class="flex items-center mb-3">
                                <h3 class="text-md font-medium text-gray-900" x-text="project.name"></h3>
                                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full" 
                                      x-text="project.folders.length + ' folder(s)'"></span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <template x-for="folder in project.folders" :key="folder.id">
                                    <div class="bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="p-4">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-start space-x-2 flex-1 min-w-0">
                                                    <button @click="toggleFolder(folder.id)"
                                                            class="p-1 text-gray-400 hover:text-gray-600 transition-transform mt-0.5"
                                                            :class="{'rotate-90': expandedFolders[folder.id]}"
                                                            title="Toggle folder contents">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                        </svg>
                                                    </button>
                                                    <div class="flex-1 min-w-0">
                                                        <h4 class="text-sm font-medium text-gray-900 truncate" x-text="folder.name"></h4>
                                                        <p class="text-xs text-gray-600 mt-1" x-text="folder.description || 'No description'"></p>
                                                        <div class="flex items-center space-x-1 mt-2">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                                Project Folder
                                                            </span>
                                                            <span class="text-xs text-gray-500" 
                                                                  x-text="(folder.conversations ? folder.conversations.length : 0) + ' conversation(s)'"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-1 ml-2">
                                                    <button @click="editFolder(folder)"
                                                            class="p-1 text-gray-400 hover:text-gray-600"
                                                            title="Edit Folder">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                    </button>
                                                    <button @click="deleteFolder(folder.id)"
                                                            class="p-1 text-gray-400 hover:text-red-600"
                                                            title="Delete Folder">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Folder contents -->
                                        <div x-show="expandedFolders[folder.id]" 
                                             x-transition:enter="transition ease-out duration-200"
                                             x-transition:enter-start="opacity-0 transform scale-95"
                                             x-transition:enter-end="opacity-100 transform scale-100"
                                             x-transition:leave="transition ease-in duration-150"
                                             x-transition:leave-start="opacity-100 transform scale-100"
                                             x-transition:leave-end="opacity-0 transform scale-95"
                                             class="px-4 pb-4 border-t border-gray-200">
                                            <div class="mt-3 space-y-2">
                                                <template x-for="conversation in folder.conversations || []" :key="conversation.id">
                                                    <div class="bg-white rounded border border-gray-200 p-3 hover:shadow-sm transition-shadow">
                                                        <div class="flex items-start justify-between">
                                                            <div class="flex-1 min-w-0">
                                                                <h5 class="text-xs font-medium text-gray-900 truncate" x-text="conversation.title"></h5>
                                                                <div class="flex items-center space-x-2 mt-1">
                                                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium"
                                                                          :class="getStatusClass(conversation.status)"
                                                                          x-text="conversation.status || 'draft'"></span>
                                                                    <span class="text-xs text-gray-500" 
                                                                          x-text="new Date(conversation.updated_at).toLocaleDateString()"></span>
                                                                </div>
                                                            </div>
                                                            <button @click="viewConversation(conversation.id)"
                                                                    class="p-1 text-gray-400 hover:text-blue-600 ml-2"
                                                                    title="View Conversation">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div x-show="!folder.conversations || folder.conversations.length === 0" 
                                                     class="text-center text-gray-500 py-4 text-xs">
                                                    <p>No conversations in this folder</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- General Folders -->
            <template x-for="folder in generalFolders" :key="folder.id">
                <div class="bg-white rounded-lg shadow-sm border mt-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <button @click="toggleFolder(folder.id)"
                                        class="p-1 text-gray-400 hover:text-gray-600 transition-transform"
                                        :class="{'rotate-90': expandedFolders[folder.id]}"
                                        title="Toggle folder contents">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900" x-text="folder.name"></h2>
                                    <p class="text-sm text-gray-600" x-text="folder.description || 'No description'"></p>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span class="text-xs text-gray-500" 
                                              x-text="(folder.conversations ? folder.conversations.length : 0) + ' conversation(s)'"></span>
                                        <span x-show="folder.children && folder.children.length > 0" 
                                              class="text-xs text-gray-500" 
                                              x-text="folder.children.length + ' subfolder(s)'"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button @click="editFolder(folder)"
                                        class="p-2 text-gray-400 hover:text-gray-600"
                                        title="Edit Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button @click="deleteFolder(folder.id)"
                                        class="p-2 text-gray-400 hover:text-red-600"
                                        title="Delete Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div x-show="expandedFolders[folder.id]" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 transform scale-95"
                         x-transition:enter-end="opacity-100 transform scale-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 transform scale-100"
                         x-transition:leave-end="opacity-0 transform scale-95"
                         class="p-6">
                        <div :id="'folder-' + folder.id" 
                             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                             x-data="{}"
                             x-init="
                                // Initialize sortable for this folder
                                setTimeout(() => {
                                    if (typeof Sortable !== 'undefined') {
                                        const folderSortable = new Sortable(document.getElementById('folder-' + folder.id), {
                                            group: 'conversations',
                                            animation: 150,
                                            ghostClass: 'sortable-ghost',
                                            chosenClass: 'sortable-chosen',
                                            onEnd: function(evt) {
                                                console.log('Conversation moved in folder:', evt);
                                                // Handle conversation move logic here
                                            }
                                        });
                                    }
                                }, 100);
                             ">
                            <template x-for="conversation in folder.conversations || []" :key="conversation.id">
                                <div class="conversation-item bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm font-medium text-gray-900 truncate" x-text="conversation.title"></h3>
                                            <div class="mt-1 flex items-center space-x-2">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                      :class="getStatusClass(conversation.status)"
                                                      x-text="conversation.status || 'draft'"></span>
                                            </div>
                                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                                <span x-text="new Date(conversation.updated_at).toLocaleDateString()"></span>
                                                <span x-show="conversation.client_name" 
                                                      x-text="'Client: ' + conversation.client_name"></span>
                                                <span x-show="conversation.project_name" 
                                                      x-text="'Project: ' + conversation.project_name"></span>
                                                <span x-show="conversation.content_type" 
                                                      x-text="'Type: ' + conversation.content_type"></span>
                                            </div>
                                            <div class="flex flex-wrap gap-1 mt-2" x-show="conversation.tags && conversation.tags.length > 0">
                                                <template x-for="tag in conversation.tags" :key="tag.id">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                                                          x-text="tag.name"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-1 ml-2">
                                            <button @click="viewConversation(conversation.id)"
                                                    class="p-1 text-gray-400 hover:text-blue-600"
                                                    title="View Conversation">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                            <button @click="deleteConversation(conversation.id)"
                                                    class="p-1 text-gray-400 hover:text-red-600"
                                                    title="Delete">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!folder.conversations || folder.conversations.length === 0" 
                                 class="col-span-full text-center text-gray-500 py-8">
                                <p>No conversations in this folder</p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- Include Modals -->
    {% include 'components/modals/client_modal.html' %}
    {% include 'components/modals/project_modal.html' %}
    {% include 'components/modals/folder_modal.html' %}
    
    <!-- Additional modals would go here -->
    {# {% include 'components/modals/status_modal.html' %} #}
</div>
{% endblock %}

{% block scripts %}
<script>
// Alpine.js Data Function for Conversation Browser
function conversationBrowser() {
    return {
        loading: true,
        error: null,
        folders: [],
        rootConversations: [],
        clients: [],
        projects: [],
        contentTemplates: [],
        statusCounts: {
            draft: 0,
            review: 0,
            approved: 0,
            rejected: 0,
            published: 0
        },
        statusFilter: '',
        showCreateFolderModal: false,
        showEditFolderModal: false,
        showCreateClientModal: false,
        showCreateProjectModal: false,
        showContentTemplatesModal: false,
        showStatusUpdateModal: false,
        filters: {
            clientId: '',
            projectId: '',
            contentType: '',
            status: '',
            startDate: '',
            endDate: ''
        },
        newFolder: {
            name: '',
            description: '',
            project_id: ''
        },
        editingFolder: {
            id: null,
            name: '',
            description: '',
            project_id: ''
        },
        newClient: {
            name: '',
            company: '',
            email: '',
            phone: '',
            industry: '',
            notes: ''
        },
        newProject: {
            client_id: '',
            name: '',
            description: '',
            project_type: 'content_creation',
            start_date: '',
            end_date: '',
            budget: ''
        },
        statusUpdate: {
            conversation_id: null,
            project_id: null,
            status: 'draft',
            content_type: '',
            review_notes: '',
            assigned_to: ''
        },
        expandedFolders: {},
        searchResults: [],

        // Computed properties for organizing folders
        get projectsWithFolders() {
            const projectFolders = {};
            
            // Group folders by project
            this.folders.forEach(folder => {
                if (folder.project_id) {
                    if (!projectFolders[folder.project_id]) {
                        projectFolders[folder.project_id] = [];
                    }
                    projectFolders[folder.project_id].push(folder);
                }
            });
            
            // Convert to array with project info
            return Object.keys(projectFolders).map(projectId => {
                const project = this.projects.find(p => p.id === projectId);
                return {
                    id: projectId,
                    name: project ? project.name : 'Unknown Project',
                    folders: projectFolders[projectId]
                };
            });
        },

        get generalFolders() {
            return this.folders.filter(folder => !folder.project_id);
        },

        // Folder management methods
        toggleFolder(folderId) {
            this.expandedFolders[folderId] = !this.expandedFolders[folderId];
        },

        async init() {
            console.log('Alpine.js init() called');
            
            // Initialize modal states
            this.showCreateClientModal = false;
            this.showCreateProjectModal = false;
            console.log('Modal states initialized:', {
                showCreateClientModal: this.showCreateClientModal,
                showCreateProjectModal: this.showCreateProjectModal
            });
            
            await this.loadData();
        },

        async loadData() {
            try {
                this.loading = true;
                this.error = null;
                
                // Load all data in parallel
                await Promise.all([
                    this.loadFolders(),
                    this.loadMarketingData()
                ]);
                
                this.loading = false;
            } catch (error) {
                console.error('Error loading data:', error);
                this.error = 'Failed to load data';
                this.loading = false;
            }
        },

        async loadFolders() {
            try {
                const response = await fetch('/api/folders/hierarchy');
                if (response.ok) {
                    const data = await response.json();
                    this.folders = data.folders || [];
                    this.rootConversations = data.root_conversations || [];
                    console.log('Loaded folders:', this.folders.length);
                    console.log('Loaded root conversations:', this.rootConversations.length);
                }
            } catch (error) {
                console.error('Error loading folders:', error);
            }
        },

        async loadConversations() {
            try {
                // Build query parameters for filtering
                const params = new URLSearchParams();
                
                if (this.filters.clientId) {
                    params.append('client_id', this.filters.clientId);
                }
                if (this.filters.projectId) {
                    params.append('project_id', this.filters.projectId);
                }
                if (this.filters.contentType) {
                    params.append('content_type', this.filters.contentType);
                }
                if (this.filters.status) {
                    params.append('status', this.filters.status);
                }
                if (this.filters.startDate) {
                    params.append('start_date', this.filters.startDate);
                }
                if (this.filters.endDate) {
                    params.append('end_date', this.filters.endDate);
                }
                
                // Use the search API to get conversations with all the metadata
                const response = await fetch(`/api/search/conversations?${params.toString()}`);
                if (response.ok) {
                    const conversations = await response.json();
                    
                    // Map the search results to our conversation format
                    this.rootConversations = conversations.map(conv => ({
                        id: conv.id,
                        title: conv.title,
                        created_at: conv.created_at,
                        updated_at: conv.updated_at,
                        message_count: 0, // Will be updated separately
                        client_id: conv.client_id,
                        client_name: conv.client_name,
                        project_id: conv.project_id,
                        project_name: conv.project_name,
                        content_type: conv.content_type,
                        status: conv.status,
                        folder_name: conv.folder_name
                    }));
                    
                    console.log('Loaded conversations:', this.rootConversations.length);
                } else {
                    console.error('Failed to load conversations');
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        },

        async applyConversationFilters() {
            console.log('Applying conversation filters:', this.filters);
            await this.loadConversations();
        },

        clearConversationFilters() {
            this.filters = {
                clientId: '',
                projectId: '',
                contentType: '',
                status: '',
                startDate: '',
                endDate: ''
            };
            this.loadConversations();
        },

        async loadMarketingData() {
            try {
                // Load clients
                const clientsResponse = await fetch('/api/clients');
                if (clientsResponse.ok) {
                    this.clients = await clientsResponse.json();
                }

                // Load projects
                const projectsResponse = await fetch('/api/projects');
                if (projectsResponse.ok) {
                    this.projects = await projectsResponse.json();
                }

                // Load content templates
                const templatesResponse = await fetch('/api/content-templates');
                if (templatesResponse.ok) {
                    this.contentTemplates = await templatesResponse.json();
                }

                // Load status counts
                const statusResponse = await fetch('/api/content-status/summary');
                if (statusResponse.ok) {
                    this.statusCounts = await statusResponse.json();
                }
            } catch (error) {
                console.error('Error loading marketing data:', error);
            }
        },

        async createClient() {
            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newClient)
                });
                
                if (response.ok) {
                    this.showCreateClientModal = false;
                    this.newClient = { name: '', company: '', email: '', phone: '', industry: '', notes: '' };
                    // Just refresh the clients list instead of all marketing data
                    const clientsResponse = await fetch('/api/clients');
                    if (clientsResponse.ok) {
                        this.clients = await clientsResponse.json();
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Client creation failed:', response.status, errorData);
                    this.error = `Failed to create client: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                this.error = 'Failed to create client';
                console.error('Error creating client:', error);
            }
        },

        async createProject() {
            try {
                console.log('Creating project with data:', this.newProject);
                console.log('Available clients:', this.clients);
                console.log('Selected client_id:', this.newProject.client_id);
                console.log('Client_id type:', typeof this.newProject.client_id);
                
                // Prepare project data, converting empty strings to null for optional fields
                const projectData = {
                    client_id: this.newProject.client_id,
                    name: this.newProject.name,
                    description: this.newProject.description || null,
                    project_type: this.newProject.project_type,
                    start_date: this.newProject.start_date || null,
                    end_date: this.newProject.end_date || null,
                    budget: this.newProject.budget ? parseFloat(this.newProject.budget) : null
                };
                
                console.log('Sending project data:', projectData);
                
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
                
                if (response.ok) {
                    this.showCreateProjectModal = false;
                    this.newProject = { client_id: '', name: '', description: '', project_type: 'content_creation', start_date: '', end_date: '', budget: '' };
                    // Just refresh the projects list instead of all marketing data
                    const projectsResponse = await fetch('/api/projects');
                    if (projectsResponse.ok) {
                        this.projects = await projectsResponse.json();
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Project creation failed:', response.status, errorData);
                    console.error('Error details:', errorData.detail);
                    this.error = `Failed to create project: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                this.error = 'Failed to create project';
                console.error('Error creating project:', error);
            }
        },

        viewConversation(conversationId) {
            // Redirect to the main chat page with the conversation ID
            console.log('Viewing conversation with ID:', conversationId);
            console.log('Redirecting to:', `/?conversation_id=${conversationId}`);
            window.location.href = `/?conversation_id=${conversationId}`;
        },

        updateContentStatus(conversationId) {
            this.statusUpdate.conversation_id = conversationId;
            this.showStatusUpdateModal = true;
        },

        async deleteConversation(conversationId) {
            if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/conversations/${conversationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from local arrays
                    this.rootConversations = this.rootConversations.filter(c => c.id !== conversationId);
                    // Also remove from folder conversations
                    this.folders.forEach(folder => {
                        if (folder.conversations) {
                            folder.conversations = folder.conversations.filter(c => c.id !== conversationId);
                        }
                    });
                    console.log('Conversation deleted successfully');
                } else {
                    const errorData = await response.json();
                    console.error('Failed to delete conversation:', errorData);
                    this.error = `Failed to delete conversation: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                this.error = 'Failed to delete conversation';
            }
        },

        editFolder(folder) {
            this.editingFolder = {
                id: folder.id,
                name: folder.name,
                description: folder.description || '',
                project_id: folder.project_id || ''
            };
            this.showEditFolderModal = true;
        },



        getStatusClass(status) {
            const statusClasses = {
                'draft': 'status-draft',
                'review': 'status-review',
                'approved': 'status-approved',
                'rejected': 'status-rejected',
                'published': 'status-published'
            };
            return statusClasses[status] || 'status-draft';
        },

        getConversationFilterLabel(key, value) {
            if (!value) return '';
            
            const labels = {
                'clientId': 'Client',
                'projectId': 'Project', 
                'contentType': 'Type',
                'status': 'Status',
                'startDate': 'From',
                'endDate': 'To'
            };
            
            const label = labels[key] || key;
            
            // Try to find the display name for the value
            if (key === 'clientId') {
                const client = this.clients.find(c => c.id === value);
                return `${label}: ${client ? client.name : value}`;
            } else if (key === 'projectId') {
                const project = this.projects.find(p => p.id === value);
                return `${label}: ${project ? project.name : value}`;
            } else {
                return `${label}: ${value}`;
            }
        },

        getFilteredConversationCount() {
            // If we have search results, use that count
            if (this.searchResults && this.searchResults.length > 0) {
                return this.searchResults.length;
            }
            
            // Otherwise, count filtered conversations from root and folders
            let count = this.rootConversations ? this.rootConversations.length : 0;
            this.folders.forEach(folder => {
                count += folder.conversations ? folder.conversations.length : 0;
            });
            return count;
        },

        getFilterLabel(key, value) {
            if (!value) return '';
            
            const labels = {
                clientId: () => {
                    const client = this.clients.find(c => c.id === value);
                    return `Client: ${client ? client.name : value}`;
                },
                projectId: () => {
                    const project = this.projects.find(p => p.id === value);
                    return `Project: ${project ? project.name : value}`;
                },
                contentType: () => `Type: ${value.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                status: () => `Status: ${value.charAt(0).toUpperCase() + value.slice(1)}`,
                startDate: () => `From: ${value}`,
                endDate: () => `To: ${value}`
            };
            return labels[key] ? labels[key]() : `${key}: ${value}`;
        },

        async createFolder() {
            try {
                const response = await fetch('/api/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newFolder)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create folder');
                }
                
                this.showCreateFolderModal = false;
                this.newFolder = { name: '', description: '', project_id: '' };
                await this.loadData();
            } catch (error) {
                this.error = 'Failed to create folder';
                console.error('Error creating folder:', error);
            }
        },

        async updateFolder() {
            try {
                const response = await fetch(`/api/folders/${this.editingFolder.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: this.editingFolder.name,
                        description: this.editingFolder.description,
                        project_id: this.editingFolder.project_id
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update folder');
                }
                
                this.showEditFolderModal = false;
                this.editingFolder = { id: null, name: '', description: '', project_id: '' };
                await this.loadData();
            } catch (error) {
                this.error = 'Failed to update folder';
                console.error('Error updating folder:', error);
            }
        },

        async deleteFolder(folderId) {
            if (!confirm('Are you sure you want to delete this folder? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/folders/${folderId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await this.loadData();
                    console.log('Folder deleted successfully');
                } else {
                    const errorData = await response.json();
                    console.error('Failed to delete folder:', errorData);
                    this.error = `Failed to delete folder: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error deleting folder:', error);
                this.error = 'Failed to delete folder';
            }
        }
    }
}
</script>
{% endblock %}
