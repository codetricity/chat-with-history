{% extends "base.html" %}

{% block title %}Content Management Hub - Conversation Browser{% endblock %}

{% block content %}
<!-- Main Application -->
<div x-data="conversationBrowser()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Content Management Hub</h1>
                    <span class="ml-3 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Marketing Firm</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="showCreateClientModal = true; console.log('Client button clicked, modal state:', showCreateClientModal)" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        New Client
                    </button>
                    <button @click="showCreateProjectModal = true; console.log('Project button clicked, modal state:', showCreateProjectModal)" 
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        New Project
                    </button>
                    <button @click="showCreateFolderModal = true" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        New Folder
                    </button>
                    <nav class="flex space-x-4">
                        <a href="/" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                        <a href="/login" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Login</a>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div x-show="loading" class="flex items-center justify-center py-12">
            <div class="loading loading-spinner loading-lg"></div>
            <span class="ml-4 text-gray-600">Loading conversations...</span>
        </div>

        <!-- Error State -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-md p-4 flex items-center">
            <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span x-text="error"></span>
        </div>

        <!-- Content -->
        <div x-show="!loading && !error">
            <!-- Advanced Search Interface -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Advanced Search</h2>
                        <div class="flex space-x-2">
                            <button @click="clearFilters()" 
                                    class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Search Bar -->
                    <div class="mb-6">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" 
                                   x-model="searchQuery" 
                                   @input.debounce.300ms="searchConversations()"
                                   placeholder="Search conversations..."
                                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <!-- Client Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                            <select x-model="filters.clientId" @change="applyFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Clients</option>
                                <template x-for="client in clients" :key="client.id">
                                    <option :value="client.id" x-text="client.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Project Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                            <select x-model="filters.projectId" @change="applyFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Projects</option>
                                <template x-for="project in projects" :key="project.id">
                                    <option :value="project.id" x-text="project.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Content Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                            <select x-model="filters.contentType" @change="applyFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Types</option>
                                <option value="blog_post">Blog Post</option>
                                <option value="social_media">Social Media</option>
                                <option value="email_campaign">Email Campaign</option>
                                <option value="ad_copy">Ad Copy</option>
                                <option value="press_release">Press Release</option>
                                <option value="case_study">Case Study</option>
                            </select>
                        </div>
                        
                        <!-- Status Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select x-model="filters.status" @change="applyFilters()"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="review">Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="published">Published</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Date Range Filter -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" x-model="filters.startDate" @change="applyFilters()"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" x-model="filters.endDate" @change="applyFilters()"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <template x-for="(value, key) in filters" :key="key">
                            <span x-show="value" 
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                <span x-text="getFilterLabel(key, value)"></span>
                                <button @click="filters[key] = ''; applyFilters()" 
                                        class="ml-1.5 inline-flex items-center justify-center w-4 h-4 rounded-full text-indigo-400 hover:bg-indigo-200 hover:text-indigo-500 focus:outline-none focus:bg-indigo-500 focus:text-white">
                                    <span class="sr-only">Remove</span>
                                    <svg class="w-2 h-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                        <path stroke-linecap="round" stroke-width="1.5" d="m1 1 6 6m0-6-6 6" />
                                    </svg>
                                </button>
                            </span>
                        </template>
                    </div>
                    
                    <!-- Search Results Summary -->
                    <div x-show="searchResults.length > 0 || (filters.clientId || filters.projectId || filters.contentType || filters.status || filters.startDate || filters.endDate)" class="text-sm text-gray-600 mb-4">
                        Found <span x-text="getFilteredConversationCount()"></span> conversations matching your search
                    </div>
                </div>
            </div>
            
            <!-- Status Overview Cards -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Content Status Overview</h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-600" x-text="statusCounts.draft || 0"></div>
                            <div class="text-sm text-gray-500">Draft</div>
                        </div>
                        <div class="text-center p-3 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" x-text="statusCounts.review || 0"></div>
                            <div class="text-sm text-gray-500">Review</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" x-text="statusCounts.approved || 0"></div>
                            <div class="text-sm text-gray-500">Approved</div>
                        </div>
                        <div class="text-center p-3 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" x-text="statusCounts.rejected || 0"></div>
                            <div class="text-sm text-gray-500">Rejected</div>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" x-text="statusCounts.published || 0"></div>
                            <div class="text-sm text-gray-500">Published</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Root Level Conversations -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Root Conversations</h2>
                    <p class="text-sm text-gray-600">Conversations not organized into folders</p>
                </div>
                <div class="p-6">
                    <div id="root-conversations" 
                         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                         x-data="{}"
                         x-init="
                            console.log('Initializing sortables...');
                            console.log('Current folders:', folders.length);
                            console.log('Current root conversations:', rootConversations.length);
                            
                            // Initialize sortable for root conversations
                            setTimeout(() => {
                                if (typeof Sortable !== 'undefined') {
                                    const rootSortable = new Sortable(document.getElementById('root-conversations'), {
                                        group: 'conversations',
                                        animation: 150,
                                        ghostClass: 'sortable-ghost',
                                        chosenClass: 'sortable-chosen',
                                        onEnd: function(evt) {
                                            console.log('Root conversation moved:', evt);
                                            // Handle conversation move logic here
                                        }
                                    });
                                    console.log('Sortable instances created:', ['root-conversations']);
                                }
                            }, 100);
                         ">
                        <template x-for="conversation in rootConversations" :key="conversation.id">
                            <div class="conversation-item bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-sm font-medium text-gray-900 truncate" x-text="conversation.title"></h3>
                                        <div class="mt-1 flex items-center space-x-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="getStatusClass(conversation.status)"
                                                  x-text="conversation.status || 'draft'"></span>
                                        </div>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                                            <span x-text="new Date(conversation.updated_at).toLocaleDateString()"></span>
                                            <span x-show="conversation.client_name" 
                                                  x-text="'Client: ' + conversation.client_name"></span>
                                            <span x-show="conversation.project_name" 
                                                  x-text="'Project: ' + conversation.project_name"></span>
                                        </div>
                                        <div class="flex flex-wrap gap-1 mt-2" x-show="conversation.tags && conversation.tags.length > 0">
                                            <template x-for="tag in conversation.tags" :key="tag.id">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                                                      x-text="tag.name"></span>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 ml-2">
                                        <button @click="viewConversation(conversation.id)"
                                                class="p-1 text-gray-400 hover:text-blue-600"
                                                title="View Conversation">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button @click="deleteConversation(conversation.id)"
                                                class="p-1 text-gray-400 hover:text-red-600"
                                                title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="rootConversations.length === 0" 
                             class="col-span-full text-center text-gray-500 py-8">
                            <p>No conversations at root level</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Folders -->
            <template x-for="folder in folders" :key="folder.id">
                <div class="bg-white rounded-lg shadow-sm border mt-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-gray-900" x-text="folder.name"></h2>
                                <p class="text-sm text-gray-600" x-text="folder.description || 'No description'"></p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button @click="editFolder(folder)"
                                        class="p-2 text-gray-400 hover:text-gray-600"
                                        title="Edit Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button @click="deleteFolder(folder.id)"
                                        class="p-2 text-gray-400 hover:text-red-600"
                                        title="Delete Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div :id="'folder-' + folder.id" 
                             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                             x-data="{}"
                             x-init="
                                // Initialize sortable for this folder
                                setTimeout(() => {
                                    if (typeof Sortable !== 'undefined') {
                                        const folderSortable = new Sortable(document.getElementById('folder-' + folder.id), {
                                            group: 'conversations',
                                            animation: 150,
                                            ghostClass: 'sortable-ghost',
                                            chosenClass: 'sortable-chosen',
                                            onEnd: function(evt) {
                                                console.log('Conversation moved in folder:', evt);
                                                // Handle conversation move logic here
                                            }
                                        });
                                    }
                                }, 100);
                             ">
                            <template x-for="conversation in folder.conversations || []" :key="conversation.id">
                                <div class="conversation-item bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm font-medium text-gray-900 truncate" x-text="conversation.title"></h3>
                                            <div class="mt-1 flex items-center space-x-2">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                      :class="getStatusClass(conversation.status)"
                                                      x-text="conversation.status || 'draft'"></span>
                                            </div>
                                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                                <span x-text="new Date(conversation.updated_at).toLocaleDateString()"></span>
                                                <span x-show="conversation.client_name" 
                                                      x-text="'Client: ' + conversation.client_name"></span>
                                                <span x-show="conversation.project_name" 
                                                      x-text="'Project: ' + conversation.project_name"></span>
                                            </div>
                                            <div class="flex flex-wrap gap-1 mt-2" x-show="conversation.tags && conversation.tags.length > 0">
                                                <template x-for="tag in conversation.tags" :key="tag.id">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                                                          x-text="tag.name"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-1 ml-2">
                                            <button @click="viewConversation(conversation.id)"
                                                    class="p-1 text-gray-400 hover:text-blue-600"
                                                    title="View Conversation">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                            <button @click="deleteConversation(conversation.id)"
                                                    class="p-1 text-gray-400 hover:text-red-600"
                                                    title="Delete">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!folder.conversations || folder.conversations.length === 0" 
                                 class="col-span-full text-center text-gray-500 py-8">
                                <p>No conversations in this folder</p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- Include Modals -->
    {% include 'components/modals/client_modal.html' %}
    {% include 'components/modals/project_modal.html' %}
    
    <!-- Additional modals would go here -->
    {# {% include 'components/modals/folder_modal.html' %} #}
    {# {% include 'components/modals/status_modal.html' %} #}
</div>
{% endblock %}

{% block scripts %}
<script>
// Alpine.js Data Function for Conversation Browser
function conversationBrowser() {
    return {
        loading: true,
        error: null,
        folders: [],
        rootConversations: [],
        clients: [],
        projects: [],
        contentTemplates: [],
        statusCounts: {
            draft: 0,
            review: 0,
            approved: 0,
            rejected: 0,
            published: 0
        },
        statusFilter: '',
        showCreateFolderModal: false,
        showEditFolderModal: false,
        showCreateClientModal: false,
        showCreateProjectModal: false,
        showContentTemplatesModal: false,
        showStatusUpdateModal: false,
        searchQuery: '',
        searchResults: [],
        filters: {
            clientId: '',
            projectId: '',
            contentType: '',
            status: '',
            startDate: '',
            endDate: ''
        },
        newFolder: {
            name: '',
            description: ''
        },
        editingFolder: {
            id: null,
            name: '',
            description: ''
        },
        newClient: {
            name: '',
            company: '',
            email: '',
            phone: '',
            industry: '',
            notes: ''
        },
        newProject: {
            client_id: '',
            name: '',
            description: '',
            project_type: 'content_creation',
            start_date: '',
            end_date: '',
            budget: ''
        },
        statusUpdate: {
            conversation_id: null,
            project_id: null,
            status: 'draft',
            content_type: '',
            review_notes: '',
            assigned_to: ''
        },

        async init() {
            console.log('Alpine.js init() called');
            
            // Initialize modal states
            this.showCreateClientModal = false;
            this.showCreateProjectModal = false;
            console.log('Modal states initialized:', {
                showCreateClientModal: this.showCreateClientModal,
                showCreateProjectModal: this.showCreateProjectModal
            });
            
            await this.loadData();
        },

        async loadData() {
            try {
                this.loading = true;
                this.error = null;
                
                // Load all data in parallel
                await Promise.all([
                    this.loadFolders(),
                    this.loadMarketingData()
                ]);
                
                this.loading = false;
            } catch (error) {
                console.error('Error loading data:', error);
                this.error = 'Failed to load data';
                this.loading = false;
            }
        },

        async loadFolders() {
            try {
                const response = await fetch('/api/folders/hierarchy');
                if (response.ok) {
                    const data = await response.json();
                    this.folders = data.folders || [];
                    this.rootConversations = data.root_conversations || [];
                    console.log('Loaded folders:', this.folders.length);
                    console.log('Loaded root conversations:', this.rootConversations.length);
                }
            } catch (error) {
                console.error('Error loading folders:', error);
            }
        },

        async loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                if (response.ok) {
                    this.rootConversations = await response.json();
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        },

        async loadMarketingData() {
            try {
                // Load clients
                const clientsResponse = await fetch('/api/clients');
                if (clientsResponse.ok) {
                    this.clients = await clientsResponse.json();
                }

                // Load projects
                const projectsResponse = await fetch('/api/projects');
                if (projectsResponse.ok) {
                    this.projects = await projectsResponse.json();
                }

                // Load content templates
                const templatesResponse = await fetch('/api/content-templates');
                if (templatesResponse.ok) {
                    this.contentTemplates = await templatesResponse.json();
                }

                // Load status counts
                const statusResponse = await fetch('/api/content-status/summary');
                if (statusResponse.ok) {
                    this.statusCounts = await statusResponse.json();
                }
            } catch (error) {
                console.error('Error loading marketing data:', error);
            }
        },

        async createClient() {
            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newClient)
                });
                
                if (response.ok) {
                    this.showCreateClientModal = false;
                    this.newClient = { name: '', company: '', email: '', phone: '', industry: '', notes: '' };
                    // Just refresh the clients list instead of all marketing data
                    const clientsResponse = await fetch('/api/clients');
                    if (clientsResponse.ok) {
                        this.clients = await clientsResponse.json();
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Client creation failed:', response.status, errorData);
                    this.error = `Failed to create client: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                this.error = 'Failed to create client';
                console.error('Error creating client:', error);
            }
        },

        async createProject() {
            try {
                console.log('Creating project with data:', this.newProject);
                console.log('Available clients:', this.clients);
                console.log('Selected client_id:', this.newProject.client_id);
                console.log('Client_id type:', typeof this.newProject.client_id);
                
                // Prepare project data, converting empty strings to null for optional fields
                const projectData = {
                    client_id: this.newProject.client_id,
                    name: this.newProject.name,
                    description: this.newProject.description || null,
                    project_type: this.newProject.project_type,
                    start_date: this.newProject.start_date || null,
                    end_date: this.newProject.end_date || null,
                    budget: this.newProject.budget ? parseFloat(this.newProject.budget) : null
                };
                
                console.log('Sending project data:', projectData);
                
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
                
                if (response.ok) {
                    this.showCreateProjectModal = false;
                    this.newProject = { client_id: '', name: '', description: '', project_type: 'content_creation', start_date: '', end_date: '', budget: '' };
                    // Just refresh the projects list instead of all marketing data
                    const projectsResponse = await fetch('/api/projects');
                    if (projectsResponse.ok) {
                        this.projects = await projectsResponse.json();
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Project creation failed:', response.status, errorData);
                    console.error('Error details:', errorData.detail);
                    this.error = `Failed to create project: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                this.error = 'Failed to create project';
                console.error('Error creating project:', error);
            }
        },

        viewConversation(conversationId) {
            // Redirect to the main chat page with the conversation ID
            window.location.href = `/?conversation_id=${conversationId}`;
        },

        updateContentStatus(conversationId) {
            this.statusUpdate.conversation_id = conversationId;
            this.showStatusUpdateModal = true;
        },

        async deleteConversation(conversationId) {
            if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/conversations/${conversationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from local arrays
                    this.rootConversations = this.rootConversations.filter(c => c.id !== conversationId);
                    // Also remove from folder conversations
                    this.folders.forEach(folder => {
                        if (folder.conversations) {
                            folder.conversations = folder.conversations.filter(c => c.id !== conversationId);
                        }
                    });
                    console.log('Conversation deleted successfully');
                } else {
                    const errorData = await response.json();
                    console.error('Failed to delete conversation:', errorData);
                    this.error = `Failed to delete conversation: ${errorData.detail || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                this.error = 'Failed to delete conversation';
            }
        },

        editFolder(folder) {
            // For now, just show an alert. In a real app, you'd open an edit modal
            alert(`Edit folder: ${folder.name}\n\nThis feature would open an edit dialog.`);
        },

        async searchConversations() {
            if (!this.searchQuery.trim()) {
                this.searchResults = [];
                // Reload all conversations when search is cleared
                await this.loadFolders();
                return;
            }

            try {
                const response = await fetch(`/api/search/conversations?q=${encodeURIComponent(this.searchQuery)}`);
                if (response.ok) {
                    const searchResults = await response.json();
                    this.searchResults = searchResults;
                    
                    // Update the displayed conversations with search results
                    this.rootConversations = searchResults.filter(conv => !conv.folder_id);
                    
                    // Update folder conversations
                    this.folders.forEach(folder => {
                        folder.conversations = searchResults.filter(conv => conv.folder_id === folder.id);
                    });
                    
                    console.log('Search results:', searchResults.length);
                }
            } catch (error) {
                console.error('Search error:', error);
                this.searchResults = [];
            }
        },

        async applyFilters() {
            console.log('Applying filters:', this.filters);
            
            try {
                // Clear search results when applying filters
                this.searchResults = [];
                
                // Build query parameters
                const params = new URLSearchParams();
                
                // Add search query if present
                if (this.searchQuery.trim()) {
                    params.append('q', this.searchQuery.trim());
                }
                
                // Add filter parameters
                if (this.filters.clientId) {
                    params.append('client_id', this.filters.clientId);
                }
                if (this.filters.projectId) {
                    params.append('project_id', this.filters.projectId);
                }
                if (this.filters.contentType) {
                    params.append('content_type', this.filters.contentType);
                }
                if (this.filters.status) {
                    params.append('status', this.filters.status);
                }
                if (this.filters.startDate) {
                    params.append('start_date', this.filters.startDate);
                }
                if (this.filters.endDate) {
                    params.append('end_date', this.filters.endDate);
                }
                
                // Make API call to search endpoint
                const response = await fetch(`/api/search/conversations?${params.toString()}`);
                if (response.ok) {
                    const filteredConversations = await response.json();
                    
                    // Update the displayed conversations
                    this.rootConversations = filteredConversations.filter(conv => !conv.folder_id);
                    
                    // Update folder conversations
                    this.folders.forEach(folder => {
                        folder.conversations = filteredConversations.filter(conv => conv.folder_id === folder.id);
                    });
                    
                    console.log('Filtered conversations:', filteredConversations.length);
                } else {
                    console.error('Filter request failed:', response.status);
                    const errorData = await response.json();
                    console.error('Error details:', errorData);
                }
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        },

        async clearFilters() {
            this.filters = {
                clientId: '',
                projectId: '',
                contentType: '',
                status: '',
                startDate: '',
                endDate: ''
            };
            this.searchQuery = '';
            this.searchResults = [];
            
            // Reload all conversations when clearing filters
            await this.loadFolders();
        },

        getStatusClass(status) {
            const statusClasses = {
                'draft': 'status-draft',
                'review': 'status-review',
                'approved': 'status-approved',
                'rejected': 'status-rejected',
                'published': 'status-published'
            };
            return statusClasses[status] || 'status-draft';
        },

        getFilteredConversationCount() {
            // If we have search results, use that count
            if (this.searchResults.length > 0) {
                return this.searchResults.length;
            }
            
            // Otherwise, count filtered conversations from root and folders
            let count = this.rootConversations.length;
            this.folders.forEach(folder => {
                count += folder.conversations ? folder.conversations.length : 0;
            });
            return count;
        },

        getFilterLabel(key, value) {
            if (!value) return '';
            
            const labels = {
                clientId: () => {
                    const client = this.clients.find(c => c.id === value);
                    return `Client: ${client ? client.name : value}`;
                },
                projectId: () => {
                    const project = this.projects.find(p => p.id === value);
                    return `Project: ${project ? project.name : value}`;
                },
                contentType: () => `Type: ${value.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                status: () => `Status: ${value.charAt(0).toUpperCase() + value.slice(1)}`,
                startDate: () => `From: ${value}`,
                endDate: () => `To: ${value}`
            };
            return labels[key] ? labels[key]() : `${key}: ${value}`;
        }
    }
}
</script>
{% endblock %}
